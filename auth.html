<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZERIONX1 · institutional algo trading</title>
    <!-- Supabase v2 CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Fonts & icon library (maintains existing theme) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* ===== EXACT DESIGN SYSTEM FROM DASHBOARD ===== */
        :root {
            --bg-primary: #03050A;
            --bg-secondary: #0B0F16;
            --bg-card: rgba(17, 22, 31, 0.85);
            --bg-sidebar: rgba(8, 12, 19, 0.95);
            --gold-primary: #C8AA6E;
            --gold-light: #E5D2AA;
            --gold-dark: #B49450;
            --text-primary: #F2F4F8;
            --text-secondary: #C0C8D2;
            --text-muted: #5D697A;
            --border-color: rgba(200, 170, 110, 0.15);
            --success: #00C851;
            --error: #ff4444;
            --warning: #ffbb33;
            --glass-edge: 1px solid rgba(200, 170, 110, 0.1);
            --gradient-gold: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
            --shadow-heavy: 0 30px 60px -12px rgba(0, 0, 0, 0.8);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            background: var(--bg-primary);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            padding: 1.5rem;
            color: var(--text-primary);
            position: relative;
            isolation: isolate;
        }

        /* subtle market grid background (existing signature) */
        body::before {
            content: "";
            position: absolute;
            inset: 0;
            background-image: 
                linear-gradient(rgba(200, 170, 110, 0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(200, 170, 110, 0.02) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
            z-index: -1;
        }

        .auth-container {
            width: 100%;
            max-width: 460px;
            animation: fadeInUp 0.6s ease-out;
        }

        /* glassmorphism card – matching dashboard cards */
        .auth-card {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: var(--glass-edge);
            border-radius: 2rem;
            padding: 2.5rem 2rem;
            box-shadow: var(--shadow-heavy);
            transition: var(--transition);
        }

        .auth-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-heavy);
            border-color: rgba(200, 170, 110, 0.3);
        }

        /* ZERIONX1 header – exact replica of platform style */
        .brand-header {
            text-align: center;
            margin-bottom: 2.5rem;
        }

        .brand-header h1 {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 2.5rem;
            font-weight: 700;
            background: var(--gradient-gold);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 0.5rem;
            letter-spacing: -0.5px;
        }

        .brand-header h1 span {
            color: var(--gold-primary);
        }

        .brand-header .badge {
            display: inline-block;
            background: rgba(200, 170, 110, 0.12);
            border: 1px solid var(--border-color);
            border-radius: 60px;
            padding: 0.3rem 1.2rem;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--gold-light);
            letter-spacing: 0.3px;
            backdrop-filter: blur(4px);
        }

        /* tabs – signup / login */
        .tab-bar {
            display: flex;
            gap: 0.5rem;
            background: rgba(0, 0, 0, 0.3);
            padding: 0.4rem;
            border-radius: 3rem;
            border: var(--glass-edge);
            margin-bottom: 2rem;
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 0.8rem 0.5rem;
            font-weight: 600;
            font-size: 1rem;
            border-radius: 3rem;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            transition: var(--transition);
            border: none;
            font-family: inherit;
            letter-spacing: 0.3px;
        }

        .tab.active {
            background: var(--gradient-gold);
            color: var(--bg-primary);
            font-weight: 700;
        }

        .tab:not(.active):hover {
            color: var(--gold-light);
            background: rgba(200, 170, 110, 0.1);
        }

        /* form area */
        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 1.8rem;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .input-group label {
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--gold-light);
            margin-left: 0.75rem;
        }

        .email-field {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--border-color);
            border-radius: 3rem;
            padding: 1rem 1.5rem;
            font-size: 1rem;
            color: var(--text-primary);
            font-family: inherit;
            transition: var(--transition);
            outline: none;
            width: 100%;
        }

        .email-field:focus {
            border-color: var(--gold-primary);
            box-shadow: 0 0 0 3px rgba(200, 170, 110, 0.2);
            background: rgba(0, 0, 0, 0.6);
        }

        .email-field::placeholder {
            color: var(--text-muted);
            font-weight: 300;
            opacity: 0.6;
        }

        /* premium button with gold gradient */
        .magic-btn {
            background: var(--gradient-gold);
            border: none;
            border-radius: 3rem;
            padding: 1rem 1.5rem;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 10px 20px -8px var(--gold-primary);
            width: 100%;
            font-family: inherit;
        }

        .magic-btn i {
            font-size: 1.1rem;
            color: var(--bg-primary);
        }

        .magic-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px -10px var(--gold-primary);
        }

        .magic-btn:disabled {
            opacity: 0.55;
            cursor: not-allowed;
            background: var(--text-muted);
            box-shadow: none;
            transform: none;
        }

        .spinner {
            width: 1.2rem;
            height: 1.2rem;
            border: 2px solid rgba(0,0,0,0.2);
            border-radius: 50%;
            border-top-color: var(--bg-primary);
            animation: spin 0.8s linear infinite;
        }

        /* status message */
        .status-area {
            min-height: 3.5rem;
            margin-top: 0.5rem;
        }

        .status-box {
            background: rgba(0, 0, 0, 0.5);
            border-left: 4px solid var(--gold-primary);
            border-radius: 1rem;
            padding: 0.9rem 1.2rem;
            font-size: 0.95rem;
            color: var(--text-primary);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            gap: 0.7rem;
            border: 1px solid var(--border-color);
        }

        .status-box.error {
            border-left-color: var(--error);
            background: rgba(255, 68, 68, 0.1);
        }

        .status-box i {
            color: var(--gold-primary);
            font-size: 1.1rem;
        }

        .status-box.error i {
            color: var(--error);
        }

        .resend-hint {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-align: center;
            margin-top: 0.8rem;
        }

        .footer-note {
            margin-top: 1.8rem;
            text-align: center;
            font-size: 0.8rem;
            color: var(--text-muted);
            border-top: 1px dashed var(--border-color);
            padding-top: 1.5rem;
        }

        .footer-note i {
            color: var(--gold-light);
            margin: 0 0.2rem;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* mobile fine-tune */
        @media (max-width: 480px) {
            .auth-card { padding: 2rem 1.2rem; }
            .brand-header h1 { font-size: 2rem; }
        }
    </style>
</head>
<body>
    <div class="auth-container">
        <div class="auth-card">
            <div class="brand-header">
                <h1>ZERIONX<span>1</span></h1>
                <span class="badge"><i class="fas fa-shield-alt" style="margin-right: 6px;"></i> algorithmic · institutional</span>
            </div>

            <!-- Tabs: signup / login (both same flow) -->
            <div class="tab-bar" id="tabContainer">
                <button class="tab active" data-tab="signup">SIGN UP</button>
                <button class="tab" data-tab="login">LOGIN</button>
            </div>

            <!-- main form -->
            <div class="auth-form">
                <div class="input-group">
                    <label for="email"><i class="far fa-envelope" style="margin-right: 6px;"></i> EMAIL ADDRESS</label>
                    <input type="email" id="email" class="email-field" placeholder="you@example.com" autocomplete="email" spellcheck="false">
                </div>

                <button class="magic-btn" id="magicBtn">
                    <i class="fas fa-magic"></i>
                    <span id="btnText">Send Magic Link</span>
                    <span id="btnSpinner" class="spinner" style="display: none;"></span>
                </button>

                <!-- status area -->
                <div class="status-area" id="statusArea">
                    <!-- dynamic status injected via js -->
                </div>

                <div class="resend-hint" id="cooldownHint"></div>
            </div>

            <div class="footer-note">
                <i class="fas fa-chart-line"></i>  multi-market · forex · crypto · commodities  <i class="fas fa-chart-line"></i>
            </div>
        </div>
    </div>

    <script>
        (function() {
            // ========== SUPABASE INIT WITH PROVIDED KEYS ==========
            const supabase = window.supabase.createClient(
                'https://dpmqjvaylnszykujmufv.supabase.co',
                'sb_publishable_S2HHT0VP1Ru6Dk63ju7V-Q_FnNfX1sd'
            );

            // ========== DOM ELEMENTS ==========
            const emailInput = document.getElementById('email');
            const magicBtn = document.getElementById('magicBtn');
            const btnText = document.getElementById('btnText');
            const btnSpinner = document.getElementById('btnSpinner');
            const statusArea = document.getElementById('statusArea');
            const cooldownHint = document.getElementById('cooldownHint');
            const tabs = document.querySelectorAll('.tab');
            let activeTab = 'signup';

            // ========== COOLDOWN & STATE ==========
            let cooldownTimer = null;
            let cooldownSeconds = 0;
            let isSending = false;

            // ========== HELPER: CHECK IF MAGIC LINK RETURN ==========
            function isMagicLinkReturn() {
                return window.location.hash.includes('access_token') || 
                       window.location.href.includes('type=magiclink');
            }

            // ========== USER COLLECTION SYNC FUNCTION ==========
            async function syncUserAndRedirect(user) {
                // Prevent double execution completely
                if (window.__redirecting) return;
                window.__redirecting = true;

                try {
                    // Check if user exists in user_collection
                    const { data: existingUser, error: fetchError } = await supabase
                        .from('user_collection')
                        .select('id')
                        .eq('id', user.id)
                        .maybeSingle();

                    if (fetchError) {
                        console.warn('Error checking user existence:', fetchError);
                    }

                    // If user does not exist, insert new record
                    if (!existingUser) {
                        const { error: insertError } = await supabase
                            .from('user_collection')
                            .insert([{
                                id: user.id,
                                email: user.email,
                                account_status: 'active',
                                role: 'user',
                                plan_name: 'free',
                                payment_status: 'pending',
                                access_key: null,
                                created_at: new Date().toISOString()
                            }]);

                        if (insertError) {
                            console.warn('Error inserting user:', insertError);
                        }
                    }
                    // If user exists, do nothing
                    
                    // Redirect to dashboard
                    window.location.replace('dashboard.html');
                } catch (dbError) {
                    console.warn('Database operation failed:', dbError);
                    // Still redirect even if DB operation fails
                    window.location.replace('dashboard.html');
                }
            }

            // ========== SINGLE SOURCE OF TRUTH FOR LOGIN ==========
            supabase.auth.onAuthStateChange((event, session) => {
                // Only redirect on SIGNED_IN event AND when returning from magic link
                if (event === 'SIGNED_IN' && session?.user && isMagicLinkReturn()) {
                    setTimeout(() => {
                        syncUserAndRedirect(session.user);
                    }, 500);
                }
            });

            // ========== UI HELPERS ==========
            function showStatus(message, isError = false) {
                const icon = isError ? 'fa-exclamation-triangle' : 'fa-envelope-open-text';
                const errorClass = isError ? 'error' : '';
                statusArea.innerHTML = `
                    <div class="status-box ${errorClass}">
                        <i class="fas ${icon}"></i>
                        <span>${message}</span>
                    </div>
                `;
            }

            function clearStatus() {
                statusArea.innerHTML = '';
            }

            function setLoading(loading) {
                isSending = loading;
                if (loading) {
                    btnText.style.opacity = '0.7';
                    btnSpinner.style.display = 'inline-block';
                } else {
                    btnText.style.opacity = '1';
                    btnSpinner.style.display = 'none';
                }
                updateButtonState();
            }

            function updateButtonState() {
                magicBtn.disabled = isSending || cooldownSeconds > 0;
            }

            // Cooldown logic (30 sec)
            function startCooldown() {
                if (cooldownTimer) clearInterval(cooldownTimer);
                cooldownSeconds = 30;
                updateCooldownHint();
                updateButtonState();

                cooldownTimer = setInterval(() => {
                    cooldownSeconds -= 1;
                    if (cooldownSeconds <= 0) {
                        clearInterval(cooldownTimer);
                        cooldownTimer = null;
                        cooldownHint.innerHTML = '';
                        updateButtonState();
                    } else {
                        updateCooldownHint();
                    }
                }, 1000);
            }

            function updateCooldownHint() {
                if (cooldownSeconds > 0) {
                    cooldownHint.innerHTML = `<i class="fas fa-hourglass-half"></i> resend available in ${cooldownSeconds}s`;
                } else {
                    cooldownHint.innerHTML = '';
                }
            }

            // ========== TAB SWITCH ==========
            tabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    activeTab = tab.dataset.tab;
                    clearStatus();
                });
            });

            // ========== SEND MAGIC LINK (ONLY AUTH METHOD) ==========
            async function handleMagicLink() {
                // Prevent multiple sends
                if (isSending || cooldownSeconds > 0) return;

                const email = emailInput.value.trim();
                if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                    showStatus('Please enter a valid email address', true);
                    emailInput.focus();
                    return;
                }

                setLoading(true);
                clearStatus();

                try {
                    // Use signInWithOtp for magic link - NO OTP, pure magic link
                    const { error } = await supabase.auth.signInWithOtp({
                        email: email,
                        options: {
                            emailRedirectTo: "https://zerionx1.github.io/Zerionx/dashboard.html"
                        }
                    });

                    if (error) {
                        showStatus(error.message, true);
                        setLoading(false);
                        return;
                    }

                    // Success
                    showStatus('✨ Magic link sent! Check your email.', false);
                    startCooldown();

                } catch (err) {
                    showStatus('Connection error. Please try again.', true);
                    setLoading(false);
                }
            }

            magicBtn.addEventListener('click', (e) => {
                e.preventDefault();
                handleMagicLink();
            });

            // Submit on enter
            emailInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !magicBtn.disabled) {
                    e.preventDefault();
                    magicBtn.click();
                }
            });

            console.log('ZERIONX1 auth ready – stable magic link flow');
        })();
    </script>
</body>
</html>
